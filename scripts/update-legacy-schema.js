#!/usr/bin/env node

/**
 * Command line script used to sync the known/supported
 * types for the `legacy-proxy` extension.
 *
 * Usage (from repo root):
 *  ./scripts/update-legacy-schema.js https://store-domain.test/graphql
 */

const { join } = require('path');
const fs = require('fs').promises;
const graphql = require('graphql');
const fetch = require('node-fetch');

const endpoint = process.argv[2];
generateSDLFromEndpoint(endpoint).catch(err => {
    console.error(`Failed updating legacy schema from ${endpoint}`);
    console.error(err);
    process.exit(1);
});

async function generateSDLFromEndpoint(url) {
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'content-type': 'application/json',
        },
        body: JSON.stringify({
            query: graphql.getIntrospectionQuery(),
        }),
    });
    const { data } = await response.json();

    const schema = graphql.buildClientSchema(data);
    const sdl = graphql.printSchema(schema);
    // Dumb hacks that work swimmingly
    const modifiedSDL = sdl
        // @magento/graphql schemas should extend the root Query type
        .replace(/type\s+Query/, 'extend type Query')
        // escaping (we're already in a template string)
        .replace(/`/g, '\\`');

    const tsModule = `/* Autogenerated, do not hand edit. See scripts/update-legacy-schema.js */
import gql from 'graphql-tag';
export const typeDefs = gql\`

${modifiedSDL}
\`;\n\n`;

    const outPath = join(
        __dirname,
        '../src/extensions/legacy-proxy/typeDefs.ts',
    );

    await fs.writeFile(outPath, tsModule);
}
