#!/usr/bin/env node

/**
 * Command line script used to sync the known/supported
 * types for the `monolith-proxy` schema.
 *
 * Usage (from repo root):
 *  ./scripts/update-monolith-schema.js https://store-domain.test/graphql
 */

const { join } = require('path');
const fs = require('fs').promises;
const graphql = require('graphql');
const fetch = require('node-fetch');

const endpoint = process.argv[2];
generateSDLFromEndpoint(endpoint).catch(err => {
    console.error(`Failed updating monolith schema from ${endpoint}`);
    console.error(err);
    process.exit(1);
});

async function generateSDLFromEndpoint(url) {
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'content-type': 'application/json',
        },
        body: JSON.stringify({
            query: graphql.getIntrospectionQuery(),
        }),
    });
    const { data } = await response.json();

    const schema = graphql.buildClientSchema(data);
    const sdl = graphql.printSchema(schema);
    // Dumb hacks that work swimmingly
    const modifiedSDL = sdl
        // @magento/graphql schemas should extend the root Query type
        .replace(/type\s+Query/, 'extend type Query');

    const tsModule = `# Autogenerated, and only used for compile-time type-checking of delegated queries.
# DO NOT edit by hand. See scripts/update-monolith-schema.js
${modifiedSDL}\n\n`;

    const outPath = join(
        __dirname,
        '../src/framework/schema/monolith-proxy/schema.graphql',
    );

    await fs.writeFile(outPath, tsModule);
}
